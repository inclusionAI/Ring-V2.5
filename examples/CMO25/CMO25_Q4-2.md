**1. Notation and basic facts**  

The deck of 70 cards is split into the **top** $T$ (positions $1$–$50$) and the **bottom** $B$ (positions $51$–$70$). For a colour $c$ let  

$$
a_c = \text{number of cards of colour } c \text{ in } T, \qquad 
b_c = \text{number in } B.
$$

We have $\sum_c a_c = 50$, $\sum_c b_c = 20$, and there are 30 colours in total.

Define  

$$
M = \{c \mid a_c = 0,\ b_c > 0\}, \quad m = |M|;
$$  
$$
S = \{c \mid a_c = 1\}, \quad s = |S|;
$$  
$$
D = \{c \mid a_c \ge 2\}, \quad d = |D|.
$$

The sets $M,S,D$ are disjoint and their union consists of all colours that appear, so  

$$
m + s + d \le 30. \tag{1}
$$

From $50 = \sum a_c \ge 2d + s$ we get  

$$
s \le 50 - 2d. \tag{2}
$$

Since $50 > 30$, at least one colour must appear at least twice in $T$; hence $d \ge 1$ whenever a move is possible.

**2. Effect of one operation**  

An operation is performed as follows:  

- Choose a colour $x \in M$ and take the corresponding card $X$ from $B$.  
- Choose a colour $y \in D$ and take a card $Y$ from $T$.  
- Remove $X$ and insert it immediately above $Y$.

It is easy to verify (see Appendix) that the only changes in the $a$-counts are  

$$
a_x \to a_x + 1, \qquad a_w \to a_w - 1,
$$

where $w$ is the colour of the card that was at position $50$ (the bottom of the top) before the move. All other $a_c$ stay the same.

Consequences for the set $M$:  

- $x$ leaves $M$ because $a_x$ becomes $1$.  
- If $a_w \ge 2$ before the move, then after the move $a_w \ge 1$, so $w$ does not enter $M$. Hence $m$ **decreases by $1$** (reducing move).  
- If $a_w = 1$ before the move, then after the move $a_w = 0$ and $b_w$ increases by $1$, so $w$ enters $M$. Hence $m$ **stays the same** (neutral move).

Because $m$ never increases and the process stops exactly when $m = 0$, the total number of reducing moves equals the initial value $m_0$.

**3. The suffix of singletons**  

Define $L$ as the length of the longest suffix of $T$ (positions $50-L+1,\dots,50$) such that  

- each card in the suffix has $a_c = 1$ (its colour belongs to $S$), and  
- the colours of these cards are all distinct.

If the bottom card (position $50$) does not have $a = 1$, set $L = 0$. Clearly $L \le s$.

**Lemma 1.** *In a neutral move, $L$ decreases by exactly $1$. Moreover, a neutral move can be performed only when $L \ge 1$ (i.e., the bottom card is a singleton).*

*Proof.* Assume before the move $L = \ell \ge 1$. The bottom $\ell$ cards are distinct singletons; the card at position $50-\ell$ (if it exists) is not a singleton with a new distinct colour. Because the move is neutral, the ejected card $w$ is the bottom singleton, and the chosen $Y$ (with $a_y \ge 2$) lies at some position $q \le 50-\ell$.

After the operation, the cards originally at positions $50-\ell+1,\dots,49$ shift one place to the right, becoming positions $50-\ell+2,\dots,50$. The new card $X$ is placed at position $q \le 50-\ell$, and the card that was at position $50-\ell$ moves to $50-\ell+1$ (since $q \le 50-\ell$). Therefore the new longest suffix of distinct singletons consists exactly of the shifted block, of length $\ell-1$. If $\ell = 1$, the suffix disappears, giving $L' = 0 = \ell-1$.

If $L = 0$, the bottom card is not a singleton, so $a_w \ge 2$ and the move is reducing. Hence neutral moves require $L \ge 1$. ∎

**Corollary.** In any maximal block of consecutive neutral moves, the number of moves is at most the value of $L$ at the beginning of the block. Since $L \le s$, the number of neutral moves in a block is at most the current $s$.

**4. Bounding $s$ in terms of $m$**  

Consider any state with given $m,s,d$. From (1) and the fact that $d \ge 1$ we obtain  

$$
s \le (30 - m) - d \le 30 - m - 1 = 29 - m. \tag{3}
$$

Thus at any moment  

$$
s \le 29 - m.
$$

**5. Global counting**  

Let the initial configuration have $m = m_0$. There will be exactly $m_0$ reducing moves. Denote by $s_i$ the value of $s$ **after** $i$ reducing moves, for $i = 0,1,\dots,m_0$ (so $s_0$ is the initial $s$). Applying (3) with the current $m = m_0 - i$ gives  

$$
s_i \le 29 - (m_0 - i) = (29 - m_0) + i \qquad (i = 0,1,\dots,m_0-1). \tag{4}
$$

Now consider the sequence of operations. Between the $i$-th and $(i+1)$-th reducing move (with $i=0$ meaning before the first reducing move) there may be a block of neutral moves. By the corollary to Lemma 1, the number of neutral moves in that block cannot exceed $s_i$ (the value of $s$ at the start of the block). Summing over all such blocks, the total number $N_{\text{neut}}$ of neutral moves satisfies  

$$
N_{\text{neut}} \le \sum_{i=0}^{m_0-1} s_i \le \sum_{i=0}^{m_0-1} \bigl((29 - m_0) + i\bigr). \tag{5}
$$

Evaluating the sum:

$$
\sum_{i=0}^{m_0-1} (29 - m_0) = m_0(29 - m_0), \qquad 
\sum_{i=0}^{m_0-1} i = \frac{(m_0-1)m_0}{2}.
$$

Hence  

$$
N_{\text{neut}} \le m_0(29 - m_0) + \frac{(m_0-1)m_0}{2}.
$$

The total number of operations is  

$$
N = m_0 + N_{\text{neut}} \le m_0 + m_0(29 - m_0) + \frac{(m_0-1)m_0}{2}
   = \frac{2m_0 + 58m_0 - 2m_0^2 + m_0^2 - m_0}{2}
   = \frac{59m_0 - m_0^2}{2}. \tag{6}
$$

**6. Maximising the bound**  

The bottom part $B$ contains only 20 cards, and each colour in $M$ must have at least one card in $B$. Therefore $m_0 \le 20$. (If some colours in $M$ have more than one card in $B$, that only uses more bottom space, so the maximum possible $m_0$ is 20, attained when the 20 bottom cards are all of distinct colours none of which appear in the top.)

The function $f(m) = (59m - m^2)/2$ is a concave quadratic, increasing for $m \le 29.5$. Hence on the interval $1 \le m_0 \le 20$ its maximum is at $m_0 = 20$:  

$$
N \le \frac{59\cdot 20 - 20^2}{2} = \frac{1180 - 400}{2} = 390.
$$

Thus **no sequence of operations can exceed 390 moves**.

**7. Construction attaining 390**  

We now exhibit an initial deck and a specific sequence of moves that achieves exactly 390 operations, proving the bound is sharp.

**Choice of colours.** Use all 30 colours. Label them:

- colour $0$ (the “bulk” colour),
- colours $1,2,\dots,9$ (nine “singleton” colours),
- colours $10,11,\dots,29$ (twenty “missing” colours).

**Initial stack (top → bottom):**  

- Positions $1$–$41$: $41$ cards of colour $0$.  
- Positions $42$–$50$: one card each of colours $1,2,\dots,9$ (in this order).  
- Positions $51$–$70$: one card each of colours $10,11,\dots,29$ (in this order).

Thus initially:  

- $a_0 = 41$, $a_i = 1$ for $i=1,\dots,9$, $a_j = 0$ for $j=10,\dots,29$;  
- $b_0 = 0$, $b_i = 0$ for $i=1,\dots,9$, $b_j = 1$ for $j=10,\dots,29$;  
- $m_0 = 20$, $s_0 = 9$, $d_0 = 1$ (only colour $0$ is a duplicate);  
- The suffix of distinct singletons is positions $42$–$50$, so $L_0 = 9$.

We will maintain the following invariant after $k$ reducing moves ($k = 0,1,\dots,20$):

> **Invariant $I(k)$:** The top 50 cards consist of  
> – $41 - k$ copies of colour $0$ occupying the first $41 - k$ positions,  
> – followed by $9 + k$ distinct colours, all different from $0$, each appearing exactly once, occupying positions $42 - k$ through $50$.

The initial state ($k=0$) clearly satisfies $I(0)$.  

Assume $I(k)$ holds with $0 \le k < 20$. We show how to perform the next reducing move and the preceding neutral moves so that $I(k+1)$ holds afterwards.

**Step A – Neutral block.**  
At the start we have $m = 20 - k > 0$, $s = 9 + k$, and the suffix length $L = 9 + k$. We perform exactly $L$ neutral moves as follows:

For $j = 1$ to $L$:

- Pick any colour $x$ from the current set $M$ (size $20 - k$).
- Let $Y$ be the **rightmost** copy of colour $0$ in the top. Initially this is at position $41 - k$; after each neutral move it shifts one place to the right. In the $j$-th move it is at position $41 - k + (j-1)$.
- Execute the operation with $X$ (the card of colour $x$) and $Y$.

A straightforward induction (using the effect of a neutral move described in Lemma 1) shows that after $j$ such moves:

- The rightmost copy of colour $0$ is at position $41 - k + j$.
- Positions $41 - k + 1$ through $41 - k + j$ contain the $j$ colours used as $X$ (each now a singleton).
- Positions $41 - k + j + 1$ through $50$ contain the remaining $L - j$ original singletons.
- The size of $M$ stays $20 - k$.

When $j = L$, the rightmost copy of colour $0$ reaches position $50$, and the original block of singletons has disappeared. After these $L$ neutral moves the top is:

- Positions $1$–$(41 - k - 1)$: colour $0$ ($40 - k$ copies);
- Positions $(41 - k)$–$49$: the $L$ colours inserted during the neutral moves (all distinct and not $0$);
- Position $50$: colour $0$.

**Step B – Reducing move.**  
Now the bottom card is a duplicate (colour $0$). Perform one reducing move:

- Choose any colour $x$ from $M$ (still $20 - k$ colours are missing, and $k < 20$ ensures $M \neq \varnothing$).
- Let $Y$ be the bottom card (the colour‑$0$ card at position $50$).
- Execute the operation.

After this move:

- Colour $x$ becomes a singleton and is placed at position $50$.
- The duplicate colour‑$0$ card is ejected; the number of $0$’s in the top becomes $40 - k$ (still $\ge 20 \ge 2$).
- The $L$ colours inserted during the neutral block remain as singletons at positions $41 - k$ through $49$.
- The total number of singletons becomes $(9 + k) + 1 = 10 + k$.

Thus the top now consists of:

- Positions $1$–$(41 - (k+1))$: colour $0$ ($41 - (k+1)$ copies);
- Positions $(42 - (k+1))$–$50$: $10 + k$ distinct colours (the $L$ colours from the neutral block plus $x$), all different from $0$.

This is exactly $I(k+1)$. Moreover, $m$ decreases by one (colour $x$ leaves $M$), so we now have $m = 20 - (k+1)$.

**Termination.**  
Starting with $k=0$, we repeat the two‑step cycle for $k = 0,1,\dots,19$. After the cycle for $k=19$ we have performed $19$ reducing moves and are in state $I(19)$ ($m = 1$, $s = 28$). Then we perform the final neutral block of length $28$ followed by the last reducing move. After that, $m = 0$ and the process stops.

**Counting the moves.**  

- Reducing moves: $20$.  
- Neutral moves: sum of the lengths of the $20$ neutral blocks  
  $$
  \sum_{k=0}^{19} (9 + k) = 20 \cdot 9 + \frac{19 \cdot 20}{2} = 180 + 190 = 370.
  $$

Total operations: $20 + 370 = 390$.

All moves are legal: during neutral moves the bottom card is a singleton (so $a_w = 1$), $Y$ is a duplicate (colour $0$ with multiplicity $\ge 2$), and $M$ is non‑empty; during reducing moves the bottom card is a duplicate, $Y$ is that duplicate, and $M$ is non‑empty until the final reducing move. Hence the construction achieves exactly $390$ operations.

**Conclusion**  

We have proved that for any initial configuration and any sequence of legal operations the number of operations cannot exceed $390$, and we have provided an explicit construction that attains this number. Therefore the maximum possible number of operations is  

$$
\boxed{390}.
$$

---

**Appendix: Rigorous verification of the operation’s effect on positions**  

Let the deck before the operation be $c_1, c_2, \dots, c_{50}$ (top) and $d_1, d_2, \dots, d_{20}$ (bottom), with $c_{50}$ the bottom of the top. Choose $X = d_p$ (colour $x$) and $Y = c_q$ (colour $y$). After removing $d_p$, the sequence becomes  

$$
c_1,\dots,c_{50},\; d_1,\dots,d_{p-1},d_{p+1},\dots,d_{20}.
$$

Insert $d_p$ immediately above $c_q$. The new order is  

$$
c_1,\dots,c_{q-1},\; d_p,\; c_q,\dots,c_{50},\; d_1,\dots,d_{p-1},d_{p+1},\dots,d_{20}.
$$

Taking the first 50 cards as the new top, we see:  

- If $q < 50$, the new top consists of $c_1,\dots,c_{q-1}, d_p, c_q,\dots,c_{49}$ (since $c_{50}$ moves to position $51$).  
- If $q = 50$, the new top is $c_1,\dots,c_{49}, d_p$.

In both cases the card that leaves the top is $c_{50}$, and the card that enters is $d_p$. Hence the counts $a_x$ and $a_w$ change exactly as described, and the effect on $a$-counts depends only on $x$ and $w = \text{colour}(c_{50})$. This also confirms that the choice of $Y$ can be arbitrary among the top 50 with $a_y \ge 2$. ∎